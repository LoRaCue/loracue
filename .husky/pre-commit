echo "üîç Running pre-commit quality checks..."

# Check GitHub Actions workflow files
WORKFLOW_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.github/workflows/.*\.yml$' || true)

if [ -n "$WORKFLOW_FILES" ]; then
    echo "üîç Checking GitHub Actions workflows..."
    
    if ! command -v actionlint &> /dev/null; then
        echo "‚ö†Ô∏è  actionlint not found. Install with: brew install actionlint (macOS)"
        exit 1
    fi
    
    for file in $WORKFLOW_FILES; do
        if [ -f "$file" ]; then
            # Only fail on syntax errors, not shellcheck warnings
            if ! actionlint "$file" 2>&1 | grep -E '(syntax-check|expression)'; then
                :  # No syntax errors
            else
                echo "‚ùå Workflow validation failed: $file"
                exit 1
            fi
        fi
    done
    
    echo "‚úÖ Workflow validation passed"
fi

# Get staged C/C++ files (excluding submodules)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|h|cpp|hpp)$' | grep -v -E '^components/(sx126x|u8g2|u8g2-hal-esp-idf)/' || true)

if [ -n "$STAGED_FILES" ]; then
    echo "üìù Checking code formatting..."
    
    # Check if clang-format is available
    if ! command -v clang-format &> /dev/null; then
        echo "‚ö†Ô∏è  clang-format not found. Install with: brew install clang-format (macOS) or apt install clang-format (Linux)"
        exit 1
    fi
    
    # Check formatting
    UNFORMATTED=""
    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            clang-format --dry-run --Werror "$file" 2>&1 | grep -q "warning:" && UNFORMATTED="$UNFORMATTED $file"
        fi
    done
    
    if [ -n "$UNFORMATTED" ]; then
        echo "‚ùå Code formatting issues found in:$UNFORMATTED"
        echo ""
        echo "Fix with: make format"
        echo "Or manually: clang-format -i <file>"
        exit 1
    fi
    
    echo "‚úÖ Code formatting OK"
    
    # Run static analysis on staged files
    if command -v cppcheck &> /dev/null; then
        echo "üîç Running static analysis..."
        
        CPPCHECK_FAILED=0
        for file in $STAGED_FILES; do
            if [ -f "$file" ]; then
                OUTPUT=$(cppcheck --enable=warning,style,performance,portability \
                    --suppress=missingIncludeSystem \
                    --inline-suppr \
                    --error-exitcode=1 \
                    --quiet \
                    -I main/include -I components/*/include \
                    "$file" 2>&1 | grep -v "Checking")
                
                EXITCODE=$?
                
                # Show output if there are any issues
                if [ -n "$OUTPUT" ]; then
                    echo "$OUTPUT"
                fi
                
                # Fail if cppcheck returned error
                if [ $EXITCODE -ne 0 ]; then
                    echo "‚ùå Static analysis found issues in $file"
                    CPPCHECK_FAILED=1
                fi
            fi
        done
        
        if [ $CPPCHECK_FAILED -eq 1 ]; then
            exit 1
        fi
        
        echo "‚úÖ Static analysis passed"
    else
        echo "‚ö†Ô∏è  cppcheck not found (optional). Install with: brew install cppcheck (macOS)"
    fi
fi

echo "‚úÖ Pre-commit checks passed"
