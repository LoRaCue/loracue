name: Build LoRaCue Firmware

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write

env:
  ESP_IDF_VERSION: v5.5

jobs:
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Checks
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        submodules: 'recursive'
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '22'
        cache: 'npm'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev libpixman-1-dev
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check commit message format
      if: github.event_name == 'pull_request'
      run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.sha }} --verbose

  version:
    runs-on: ubuntu-latest
    name: Calculate Version
    outputs:
      version: ${{ steps.gitversion.outputs.semVer }}
      full_version: ${{ steps.gitversion.outputs.fullSemVer }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        
    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v4.1.0
      with:
        versionSpec: '6.x'
        
    - name: Determine Version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v4.1.0
      with:
        configFilePath: GitVersion.yml

  build-hardware:
    runs-on: ubuntu-latest
    needs: [code-quality, version]
    name: Build ${{ matrix.model.display_name }}
    
    strategy:
      fail-fast: false
      matrix:
        model:
          - name: "alpha"
            display_name: "LC-Alpha"
            target: "esp32s3"
            board: "Heltec V3"
            sdkconfig: "sdkconfig.defaults;sdkconfig.heltec_v3;sdkconfig.model_alpha"
          - name: "alpha-plus"
            display_name: "LC-Alpha+"
            target: "esp32s3"
            board: "Heltec V3"
            sdkconfig: "sdkconfig.defaults;sdkconfig.heltec_v3;sdkconfig.model_alpha_plus"
          # - name: "gamma"
          #   display_name: "LC-Gamma"
          #   target: "esp32s3"
          #   board: "LilyGO T5 Pro"
          #   sdkconfig: "sdkconfig.defaults;sdkconfig.lilygo_t5;sdkconfig.model_gamma"
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        submodules: 'recursive'
        fetch-depth: 0
    
    - name: Cache ESP-IDF
      uses: actions/cache@v4
      with:
        path: |
          ~/.espressif
          ~/.cache/pip
        key: esp-idf-${{ env.ESP_IDF_VERSION }}-${{ matrix.model.target }}-${{ hashFiles('**/CMakeLists.txt', 'sdkconfig.*') }}
        restore-keys: |
          esp-idf-${{ env.ESP_IDF_VERSION }}-${{ matrix.model.target }}-
          esp-idf-${{ env.ESP_IDF_VERSION }}-
    
    - name: Install GitVersion in build environment
      shell: bash
      run: |
        wget https://github.com/GitTools/GitVersion/releases/download/6.0.5/gitversion-linux-x64-6.0.5.tar.gz
        tar -xzf gitversion-linux-x64-6.0.5.tar.gz
        chmod +x gitversion
        sudo mv gitversion /usr/local/bin/
        gitversion version
    
    - name: Generate sdkconfig from layered defaults
      shell: bash
      run: |
        echo "=== Building ${{ matrix.model.display_name }} (${{ matrix.model.board }}) ==="
        echo "Using layered sdkconfig: ${{ matrix.model.sdkconfig }}"
        rm -f sdkconfig
    
    - name: Build firmware with ESP-IDF
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: ${{ env.ESP_IDF_VERSION }}
        target: ${{ matrix.model.target }}
        command: idf.py -D SDKCONFIG_DEFAULTS="${{ matrix.model.sdkconfig }}" build
    
    - name: Validate firmware manifest
      run: |
        echo "=== Firmware Manifest Validation (esp_app_desc_t) ==="
        python3 << 'EOF'
        import struct
        import sys
        
        # ESP-IDF app descriptor is at fixed offset 0x20 in the binary
        with open('build/loracue.bin', 'rb') as f:
            f.seek(0x20)
            data = f.read(256)
            
            # esp_app_desc_t structure offsets
            magic_word = struct.unpack('<I', data[0:4])[0]
            secure_version = struct.unpack('<I', data[4:8])[0]
            version = data[16:48].decode('utf-8', errors='ignore').rstrip('\x00')
            project_name = data[48:80].decode('utf-8', errors='ignore').rstrip('\x00')
            time = data[80:96].decode('utf-8', errors='ignore').rstrip('\x00')
            date = data[96:112].decode('utf-8', errors='ignore').rstrip('\x00')
            idf_ver = data[112:144].decode('utf-8', errors='ignore').rstrip('\x00')
            
            print(f"✓ ESP-IDF app descriptor found at 0x20")
            print(f"  Magic: 0x{magic_word:08X}")
            print(f"  Project: {project_name}")
            print(f"  Version: {version}")
            print(f"  Build: {date} {time}")
            print(f"  IDF Version: {idf_ver}")
            
            # Validate project name
            if project_name != "loracue":
                print(f"✗ ERROR: Project name mismatch!")
                print(f"  Expected: loracue")
                print(f"  Found: {project_name}")
                sys.exit(1)
            
            print(f"✓ Project name validation passed")
        EOF
    
    - name: Prepare artifacts
      run: |
        VERSION="${{ needs.version.outputs.version }}"
        MODEL="${{ matrix.model.name }}"
        mkdir -p artifacts
        
        # Copy binaries
        cp "build/loracue.bin" "artifacts/loracue-${MODEL}-v${VERSION}.bin"
        cp "build/loracue.elf" "artifacts/loracue-${MODEL}-v${VERSION}.elf"
        cp build/bootloader/bootloader.bin "artifacts/bootloader-${MODEL}.bin"
        cp build/partition_table/partition-table.bin "artifacts/partition-table-${MODEL}.bin"
        
        # Generate checksums
        cd artifacts
        sha256sum "loracue-${MODEL}-v${VERSION}.bin" > "loracue-${MODEL}-v${VERSION}.bin.sha256"
        sha256sum "bootloader-${MODEL}.bin" > "bootloader-${MODEL}.bin.sha256"
        sha256sum "partition-table-${MODEL}.bin" > "partition-table-${MODEL}.bin.sha256"
        cd ..
        
        # Create metadata
        cat > "artifacts/metadata-${MODEL}.json" << EOF
        {
          "model": {
            "id": "${MODEL}",
            "display_name": "${{ matrix.model.display_name }}",
            "target": "${{ matrix.model.target }}",
            "board": "${{ matrix.model.board }}"
          },
          "firmware": {
            "version": "${VERSION}",
            "full_version": "${{ needs.version.outputs.full_version }}"
          },
          "build": {
            "date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "workflow_run": "${{ github.run_id }}",
            "esp_idf_version": "${{ env.ESP_IDF_VERSION }}"
          }
        }
        EOF
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v5
      with:
        name: loracue-${{ matrix.model.name }}-${{ needs.version.outputs.version }}
        path: artifacts/
        retention-days: 30

  security-scan:
    runs-on: ubuntu-latest
    needs: code-quality
    name: Security Scan
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        submodules: 'recursive'
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  summary:
    runs-on: ubuntu-latest
    needs: [version, build-hardware]
    if: always()
    name: Build Summary
    
    steps:
    - name: Generate build summary
      run: |
        echo "# LoRaCue Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ needs.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Status" >> $GITHUB_STEP_SUMMARY
        echo "- Hardware Build: ${{ needs.build-hardware.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Heltec LoRa V3: \`loracue-heltec_v3-${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
