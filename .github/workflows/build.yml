name: Build LoRaCue Firmware

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  ESP_IDF_VERSION: v5.5

jobs:
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Checks
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        submodules: 'recursive'
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '22'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check commit message format
      if: github.event_name == 'pull_request'
      run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.sha }} --verbose

  version:
    runs-on: ubuntu-latest
    name: Calculate Version
    outputs:
      version: ${{ steps.gitversion.outputs.semVer }}
      full_version: ${{ steps.gitversion.outputs.fullSemVer }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        
    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v4.1.0
      with:
        versionSpec: '6.x'
        
    - name: Determine Version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v4.1.0
      with:
        configFilePath: GitVersion.yml

  build-hardware:
    runs-on: ubuntu-latest
    needs: [code-quality, version]
    name: Build ${{ matrix.board.display_name }}
    
    strategy:
      fail-fast: false
      matrix:
        board:
          - name: "heltec_v3"
            display_name: "Heltec LoRa V3"
            target: "esp32s3"
            description: "ESP32-S3 with SX1262 LoRa and SH1106 OLED"
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        submodules: 'recursive'
        fetch-depth: 0
    
    - name: Cache ESP-IDF
      uses: actions/cache@v4
      with:
        path: |
          ~/.espressif
          ~/.cache/pip
        key: esp-idf-${{ env.ESP_IDF_VERSION }}-${{ matrix.board.target }}-${{ hashFiles('**/CMakeLists.txt', 'sdkconfig') }}
        restore-keys: |
          esp-idf-${{ env.ESP_IDF_VERSION }}-${{ matrix.board.target }}-
          esp-idf-${{ env.ESP_IDF_VERSION }}-
    
    - name: Install ESP-IDF
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: ${{ env.ESP_IDF_VERSION }}
        target: ${{ matrix.board.target }}
    
    - name: Build firmware
      shell: bash
      run: |
        . $IDF_PATH/export.sh
        echo "Building LoRaCue v${{ needs.version.outputs.version }} for ${{ matrix.board.display_name }}"
        idf.py fullclean
        idf.py build
    
    - name: Extract and validate firmware manifest
      shell: bash
      run: |
        echo "=== Firmware Manifest Validation ==="
        python3 << 'EOF'
        import struct
        import sys
        
        with open('build/loracue.bin', 'rb') as f:
            data = f.read(4096)
            magic = 0x4C524355  # "LRCU"
            
            for i in range(len(data) - 60):
                if struct.unpack('<I', data[i:i+4])[0] == magic:
                    manifest_version = data[i+4]
                    board_id = data[i+8:i+24].decode('utf-8', errors='ignore').rstrip('\x00')
                    fw_version = data[i+24:i+56].decode('utf-8', errors='ignore').rstrip('\x00')
                    
                    print(f"✓ Manifest found at offset {i}")
                    print(f"  Board ID: {board_id}")
                    print(f"  Firmware Version: {fw_version}")
                    print(f"  Manifest Version: {manifest_version}")
                    
                    # Validate board_id matches matrix
                    expected_board = "${{ matrix.board.name }}"
                    if board_id != expected_board:
                        print(f"✗ ERROR: Board ID mismatch!")
                        print(f"  Expected: {expected_board}")
                        print(f"  Found: {board_id}")
                        sys.exit(1)
                    
                    print(f"✓ Board ID validation passed")
                    
                    # Write manifest to file for artifacts
                    with open('manifest.json', 'w') as mf:
                        import json
                        json.dump({
                            'board_id': board_id,
                            'firmware_version': fw_version,
                            'manifest_version': manifest_version,
                            'offset': i
                        }, mf, indent=2)
                    
                    sys.exit(0)
            
            print("✗ ERROR: No valid manifest found!")
            sys.exit(1)
        EOF
    
    - name: Calculate checksums
      run: |
        cd build
        sha256sum loracue.bin > loracue.bin.sha256
        sha256sum bootloader/bootloader.bin > bootloader.sha256
        sha256sum partition_table/partition-table.bin > partition-table.sha256
        cat loracue.bin.sha256
    
    - name: Prepare artifacts
      run: |
        VERSION="${{ needs.version.outputs.version }}"
        BOARD="${{ matrix.board.name }}"
        mkdir -p artifacts
        
        # Copy binaries
        cp build/loracue.bin "artifacts/loracue-${BOARD}-v${VERSION}.bin"
        cp build/loracue.elf "artifacts/loracue-${BOARD}-v${VERSION}.elf"
        cp build/bootloader/bootloader.bin "artifacts/bootloader-${BOARD}.bin"
        cp build/partition_table/partition-table.bin "artifacts/partition-table-${BOARD}.bin"
        
        # Copy checksums
        cp build/loracue.bin.sha256 "artifacts/loracue-${BOARD}-v${VERSION}.bin.sha256"
        cp build/bootloader.sha256 "artifacts/bootloader-${BOARD}.bin.sha256"
        cp build/partition-table.sha256 "artifacts/partition-table-${BOARD}.bin.sha256"
        
        # Copy manifest
        cp manifest.json "artifacts/manifest-${BOARD}.json"
        
        # Create metadata
        cat > "artifacts/metadata-${BOARD}.json" << EOF
        {
          "board": {
            "id": "${BOARD}",
            "display_name": "${{ matrix.board.display_name }}",
            "target": "${{ matrix.board.target }}",
            "description": "${{ matrix.board.description }}"
          },
          "firmware": {
            "version": "${VERSION}",
            "full_version": "${{ needs.version.outputs.full_version }}"
          },
          "build": {
            "date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "workflow_run": "${{ github.run_id }}",
            "esp_idf_version": "${{ env.ESP_IDF_VERSION }}"
          }
        }
        EOF
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: loracue-${{ matrix.board.name }}-${{ needs.version.outputs.version }}
        path: artifacts/
        retention-days: 30

  build-simulator:
    runs-on: ubuntu-latest
    needs: [code-quality, version]
    name: Build Wokwi Simulator
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        submodules: 'recursive'
        fetch-depth: 0
    
    - name: Cache ESP-IDF
      uses: actions/cache@v4
      with:
        path: |
          ~/.espressif
          ~/.cache/pip
        key: esp-idf-${{ env.ESP_IDF_VERSION }}-esp32s3-sim-${{ hashFiles('**/CMakeLists.txt', 'sdkconfig') }}
        restore-keys: |
          esp-idf-${{ env.ESP_IDF_VERSION }}-esp32s3-
    
    - name: Install ESP-IDF
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: ${{ env.ESP_IDF_VERSION }}
        target: esp32s3
    
    - name: Build simulator firmware
      shell: bash
      run: |
        . $IDF_PATH/export.sh
        echo "Building LoRaCue v${{ needs.version.outputs.version }} for Wokwi Simulator"
        make sim
    
    - name: Prepare simulator artifacts
      run: |
        VERSION="${{ needs.version.outputs.version }}"
        mkdir -p artifacts
        cp build/loracue.bin "artifacts/loracue-wokwi_sim-v${VERSION}.bin"
        cp build/loracue.elf "artifacts/loracue-wokwi_sim-v${VERSION}.elf"
        cp diagram.json "artifacts/wokwi-diagram.json"
    
    - name: Upload simulator artifacts
      uses: actions/upload-artifact@v4
      with:
        name: loracue-wokwi_sim-${{ needs.version.outputs.version }}
        path: artifacts/
        retention-days: 30

  security-scan:
    runs-on: ubuntu-latest
    needs: code-quality
    name: Security Scan
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        submodules: 'recursive'
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  summary:
    runs-on: ubuntu-latest
    needs: [version, build-hardware, build-simulator]
    if: always()
    name: Build Summary
    
    steps:
    - name: Generate build summary
      run: |
        echo "# LoRaCue Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ needs.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Status" >> $GITHUB_STEP_SUMMARY
        echo "- Hardware Build: ${{ needs.build-hardware.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Simulator Build: ${{ needs.build-simulator.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Heltec LoRa V3: \`loracue-heltec_v3-${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Wokwi Simulator: \`loracue-wokwi_sim-${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
